<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeafSense - Crop Disease Detection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --white: #ffffff;
            --light-gray: #fbfcfd;
            --medium-gray: #f1f3f5;
            --border-gray: #dfe6ea;
            --text-gray: #5a6369;
            --dark-gray: #2f3b40;
            --black: #0f1720;
            --brand: #0b5ed7; /* primary blue */
            --brand-dark: #084b9b;
            --accent: #198754; /* success green */
        }
        
        body {
            font-family: "Inter Tight", sans-serif;
            background-color: var(--white);
            color: var(--black);
            line-height: 1.6;
        }
        
        .header {
            background-color: var(--black);
            color: var(--white);
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-gray);
        }
        
        .header h1 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            font-weight: 300;
            opacity: 0.9;
        }
        
        .card {
            border: 1px solid var(--border-gray);
            border-radius: 8px;
            background-color: var(--white);
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .card-header {
            background-color: var(--light-gray);
            border-bottom: 1px solid var(--border-gray);
            font-weight: 500;
            padding: 1rem 1.25rem;
        }
        
        .btn-primary {
            background-color: var(--brand);
            border-color: var(--brand);
            color: var(--white);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
        }

        .btn-primary:hover {
            background-color: var(--brand-dark);
            border-color: var(--brand-dark);
        }
        
        #imagePreview {
            min-height: 200px;
            background-color: var(--light-gray);
            border: 2px dashed var(--border-gray);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            padding: 0.5rem;
        }
        
        #imagePreview:hover {
            border-color: var(--dark-gray);
            background-color: var(--medium-gray);
        }
        
        #imagePreview.has-image {
            border-style: solid;
            padding: 0;
            overflow: hidden;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 260px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        
        .crop-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        .crop-item:hover {
            background-color: var(--light-gray);
        }
        
        .feature-icon {
            color: var(--black);
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }
        
        .result-card {
            background-color: var(--white);
            border-radius: 6px;
            padding: 1.25rem;
            border: 1px solid var(--border-gray);
            margin-bottom: 1rem;
        }
        
        .disease-name {
            color: var(--black);
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }
        
        .confidence-bar {
            height: 8px;
            background-color: var(--medium-gray);
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background-color: var(--accent);
            border-radius: 4px;
        }
        
        .treatment-card {
            border-left: 4px solid var(--dark-gray);
        }
        
        .prevention-card {
            border-left: 4px solid var(--text-gray);
        }
        
        .loading-modal .modal-content {
            border-radius: 8px;
            border: 1px solid var(--border-gray);
        }
        
        .spinner-border {
            width: 2.5rem;
            height: 2.5rem;
            color: var(--black);
        }
        
        .footer {
            background-color: var(--light-gray);
            color: var(--black);
            padding: 2rem 0;
            margin-top: 3rem;
            border-top: 1px solid var(--border-gray);
        }
        
        .badge {
            background-color: var(--brand);
            color: var(--white);
            font-weight: 600;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.75rem;
            }
            
            .card-body {
                padding: 1rem;
            }
        }

        /* Center and constrain the results card for better visual balance */
        #resultsSection .card {
            max-width: 1100px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header text-center">
        <div class="container">
            <h1><i class="fas fa-leaf me-2"></i>LeafSense</h1>
            <p class="mb-0">AI-Powered Crop Disease Detection System</p>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Upload Section -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Leaf Image</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="imageInput" class="form-label">Select a leaf image:</label>
                                <input type="file" class="form-control" id="imageInput" name="image" accept="image/*" required>
                                <div class="form-text">Supported formats: JPG, PNG, JPEG (Max size: 10MB)</div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label">Image Preview:</label>
                                <div id="imagePreview">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <p class="text-muted mb-1">Click to select or drag & drop an image</p>
                                    <small class="text-muted">Recommended: Clear, well-lit leaf photos</small>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100 py-2" id="submitBtn">
                                <i class="fas fa-search me-2"></i>Detect Disease
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Information Cards -->
                <div class="row">
                    <div class="col-md-6">
                        <!-- Instructions -->
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How to Use</h5>
                            </div>
                            <div class="card-body">
                                <ol class="mb-0 ps-3">
                                    <li class="mb-2">Take a clear photo of the affected leaf</li>
                                    <li class="mb-2">Ensure good lighting and focus</li>
                                    <li class="mb-2">Upload the image using the form above</li>
                                    <li class="mb-2">Wait for AI analysis (5-8 seconds)</li>
                                    <li>Review the detailed diagnosis and treatment recommendations</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- Supported Crops -->
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-seedling me-2"></i>Supported Crops</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="crop-item">
                                            <i class="fas fa-apple-alt feature-icon"></i>
                                            <span>Apples</span>
                                        </div>
                                        <div class="crop-item">
                                            <i class="fas fa-pepper-hot feature-icon"></i>
                                            <span>Peppers</span>
                                        </div>
                                        <div class="crop-item">
                                            <i class="fas fa-grape feature-icon"></i>
                                            <span>Grapes</span>
                                        </div>
                                        <div class="crop-item">
                                            <i class="fas fa-lemon feature-icon"></i>
                                            <span>Citrus</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="crop-item">
                                            <i class="fas fa-carrot feature-icon"></i>
                                            <span>Tomatoes</span>
                                        </div>
                                        <div class="crop-item">
                                            <i class="fas fa-potato feature-icon"></i>
                                            <span>Potatoes</span>
                                        </div>
                                        <div class="crop-item">
                                            <i class="fas fa-seedling feature-icon"></i>
                                            <span>Corn</span>
                                        </div>
                                        <div class="crop-item">
                                            <i class="fas fa-stroopwafel feature-icon"></i>
                                            <span>Strawberries</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section (Hidden by default) -->
        <div id="resultsSection" class="row justify-content-center mt-5" style="display: none;">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Analysis Results</h5>
                        <span class="badge">Confidence: 92%</span>
                    </div>
                    <div class="card-body">
                        <!-- Results -->
                        <div id="resultsContent">
                            <div class="disease-name">Early Blight</div>
                            <div class="text-muted mb-3">Tomato Plant</div>
                            
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: 92%"></div>
                            </div>
                            <div class="d-flex justify-content-between text-muted small mb-4">
                                <span>Detection Confidence</span>
                                <span>92%</span>
                            </div>
                            
                            <div class="result-card mt-4">
                                <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Description</h6>
                                <p class="mb-0">Early blight is a common fungal disease that affects tomatoes, potatoes, and other plants in the nightshade family. It typically appears as concentric rings on leaves, creating a "target" pattern.</p>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="result-card treatment-card">
                                    <h6 class="mb-2"><i class="fas fa-prescription-bottle me-2"></i>Recommended Treatment</h6>
                                    <ul class="mb-0 ps-3">
                                        <li>Apply copper-based fungicides</li>
                                        <li>Remove and destroy infected leaves</li>
                                        <li>Improve air circulation around plants</li>
                                        <li>Water at the base, avoid wetting leaves</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="result-card prevention-card">
                                    <h6 class="mb-2"><i class="fas fa-shield-alt me-2"></i>Prevention Tips</h6>
                                    <ul class="mb-0 ps-3">
                                        <li>Rotate crops annually</li>
                                        <li>Use disease-resistant varieties</li>
                                        <li>Space plants properly for air flow</li>
                                        <li>Apply mulch to prevent soil splash</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-primary px-4" onclick="resetForm()">
                                <i class="fas fa-upload me-2"></i>Analyze Another Image
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" aria-labelledby="loadingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="mt-3" id="loadingModalLabel">Analyzing Image...</h5>
                    <p class="text-muted">This may take a few seconds</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6 mb-4 mb-md-0">
                    <h5><i class="fas fa-leaf me-2"></i>LeafSense</h5>
                    <p>Empowering farmers with AI-driven crop health diagnostics for sustainable agriculture.</p>
                </div>
                <div class="col-md-3 mb-4 mb-md-0">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-decoration-none text-dark">How It Works</a></li>
                        <li><a href="#" class="text-decoration-none text-dark">Supported Crops</a></li>
                        <li><a href="#" class="text-decoration-none text-dark">FAQ</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contact</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-envelope me-2"></i> support@leafsense.com</li>
                        <li><i class="fas fa-phone me-2"></i> +1 (555) 123-4567</li>
                    </ul>
                </div>
            </div>
            <hr class="my-4">
            <div class="text-center">
                <p class="mb-0">&copy; 2023 LeafSense. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Keep last preview data URL so the same image can be shown in results
        let lastPreviewDataUrl = null;

        // Image preview functionality
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            const file = e.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(ev) {
                    lastPreviewDataUrl = ev.target.result;
                    preview.innerHTML = `<img src="${ev.target.result}" class="preview-image" alt="Preview">`;
                    preview.classList.add('has-image');
                }
                
                reader.readAsDataURL(file);
            } else {
                lastPreviewDataUrl = null;
                preview.innerHTML = `
                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-1">Click to select or drag & drop an image</p>
                    <small class="text-muted">Recommended: Clear, well-lit leaf photos</small>
                `;
                preview.classList.remove('has-image');
            }
        });

        // Make the preview area clickable to trigger file input
        document.getElementById('imagePreview').addEventListener('click', function() {
            document.getElementById('imageInput').click();
        });

        // Initialize loading modal once
        const loadingModalEl = document.getElementById('loadingModal');
        const loadingModal = new bootstrap.Modal(loadingModalEl, {
            backdrop: 'static',
            keyboard: false
        });

        // Form submission - send image to backend `/predict` and display real results
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            loadingModal.show();

            const form = e.target;
            const formData = new FormData(form);

            try {
                const resp = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                const data = await resp.json();

                if (!resp.ok) {
                    const message = data && data.error ? data.error : 'Prediction failed';
                    alert(message);
                    return;
                }

                // Show results section only after we know prediction succeeded
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';

                // Update the UI from the API response
                const diseaseNameEl = document.querySelector('.disease-name');
                if (diseaseNameEl) diseaseNameEl.textContent = data.disease || 'Unknown';

                const subtitleEl = document.querySelector('#resultsContent .text-muted');
                if (subtitleEl) {
                    const parts = (data.disease || '').split('_');
                    subtitleEl.textContent = parts.length ? `${parts[0]} Plant` : '';
                }

                const confidence = typeof data.confidence === 'number' ? Math.round(data.confidence * 100) : 0;
                const fill = document.querySelector('.confidence-fill');
                if (fill) fill.style.width = confidence + '%';
                const confLabels = document.querySelectorAll('.d-flex.justify-content-between.text-muted.small span');
                if (confLabels && confLabels.length >= 2) {
                    confLabels[0].textContent = 'Detection Confidence';
                    confLabels[1].textContent = confidence + '%';
                }

                const badge = document.querySelector('.card-header .badge');
                if (badge) badge.textContent = `Confidence: ${confidence}%`;

                const descEl = document.querySelector('.result-card p');
                if (descEl) descEl.textContent = data.description || 'No information available';

                const treatmentList = document.querySelector('.treatment-card ul');
                if (treatmentList) {
                    treatmentList.innerHTML = '';
                    const remedies = Array.isArray(data.remedy) ? data.remedy : String(data.remedy || '').split('\n');
                    remedies.forEach(r => {
                        if (r && r.trim()) {
                            treatmentList.insertAdjacentHTML('beforeend', `<li>${r.trim()}</li>`);
                        }
                    });
                    if (!treatmentList.children.length) {
                        treatmentList.innerHTML = '<li>No recommended treatment available</li>';
                    }
                }

                const preventionList = document.querySelector('.prevention-card ul');
                if (preventionList) {
                    preventionList.innerHTML = '';
                    const items = Array.isArray(data.prevention) ? data.prevention : String(data.prevention || '').split('\n');
                    items.forEach(item => {
                        if (item && item.trim()) {
                            preventionList.insertAdjacentHTML('beforeend', `<li>${item.trim()}</li>`);
                        }
                    });
                    if (!preventionList.children.length) {
                        preventionList.innerHTML = '<li>No prevention tips available</li>';
                    }
                }

                resultsSection.scrollIntoView({ behavior: 'smooth' });

            } catch (err) {
                console.error('Prediction error', err);
                alert('Prediction failed. See console for details.');
            } finally {
                loadingModal.hide();
            }
        });

        // Reset form function
        function resetForm() {
            document.getElementById('uploadForm').reset();
            document.getElementById('imagePreview').innerHTML = `
                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-1">Click to select or drag & drop an image</p>
                <small class="text-muted">Recommended: Clear, well-lit leaf photos</small>
            `;
            document.getElementById('imagePreview').classList.remove('has-image');
            document.getElementById('resultsSection').style.display = 'none';

            // Clear stored preview
            lastPreviewDataUrl = null;

            // Scroll back to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Drag and drop functionality
        const previewArea = document.getElementById('imagePreview');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            previewArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            previewArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            previewArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            previewArea.style.borderColor = 'var(--dark-gray)';
            previewArea.style.backgroundColor = 'var(--medium-gray)';
        }
        
        function unhighlight() {
            previewArea.style.borderColor = 'var(--border-gray)';
            previewArea.style.backgroundColor = 'var(--light-gray)';
        }
        
        previewArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('imageInput').files = files;
            
            // Trigger change event to update preview
            const event = new Event('change');
            document.getElementById('imageInput').dispatchEvent(event);
        }
    </script>
</body>
</html>